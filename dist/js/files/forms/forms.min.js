import{flsModules}from"../modules.js";import{isMobile,_slideUp,_slideDown,_slideToggle,FLS}from"../functions.js";import{gotoBlock}from"../scroll/gotoblock.js";export function formFieldsInit(e={viewPass:!1}){const t=document.querySelectorAll("input[placeholder],textarea[placeholder]");t.length&&t.forEach((e=>{e.hasAttribute("data-placeholder-nohide")||(e.dataset.placeholder=e.placeholder)})),document.body.addEventListener("focusin",(function(e){const t=e.target;"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName||(t.dataset.placeholder&&(t.placeholder=""),t.hasAttribute("data-no-focus-classes")||(t.classList.add("_form-focus"),t.parentElement.classList.add("_form-focus")),formValidate.removeError(t))})),document.body.addEventListener("focusout",(function(e){const t=e.target;"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName||(t.dataset.placeholder&&(t.placeholder=t.dataset.placeholder),t.hasAttribute("data-no-focus-classes")||(t.classList.remove("_form-focus"),t.parentElement.classList.remove("_form-focus")),t.hasAttribute("data-validate")&&formValidate.validateInput(t))})),e.viewPass&&document.addEventListener("click",(function(e){let t=e.target;if(t.closest('[class*="__viewpass"]')){let e=t.classList.contains("_viewpass-active")?"password":"text";t.parentElement.querySelector("input").setAttribute("type",e),t.classList.toggle("_viewpass-active")}}))}export let formValidate={getErrors(e){let t=0,r=e.querySelectorAll("*[data-required]");return r.length&&r.forEach((e=>{null===e.offsetParent&&"SELECT"!==e.tagName||e.disabled||(t+=this.validateInput(e))})),t},validateInput(e){let t=0;return"email"===e.dataset.required?(e.value=e.value.replace(" ",""),this.emailTest(e)?(this.addError(e),t++):this.removeError(e)):("checkbox"!==e.type||e.checked)&&e.value?this.removeError(e):(this.addError(e),t++),t},addError(e){e.classList.add("_form-error"),e.parentElement.classList.add("_form-error");let t=e.parentElement.querySelector(".form__error");t&&e.parentElement.removeChild(t),e.dataset.error&&e.parentElement.insertAdjacentHTML("beforeend",`<div class="form__error">${e.dataset.error}</div>`)},removeError(e){e.classList.remove("_form-error"),e.parentElement.classList.remove("_form-error"),e.parentElement.querySelector(".form__error")&&e.parentElement.removeChild(e.parentElement.querySelector(".form__error"))},formClean(e){e.reset(),setTimeout((()=>{let t=e.querySelectorAll("input,textarea");for(let e=0;e<t.length;e++){const r=t[e];r.parentElement.classList.remove("_form-focus"),r.classList.remove("_form-focus"),formValidate.removeError(r)}let r=e.querySelectorAll(".checkbox__input");if(r.length>0)for(let e=0;e<r.length;e++){r[e].checked=!1}if(flsModules.select){let t=e.querySelectorAll(".select");if(t.length)for(let e=0;e<t.length;e++){const r=t[e].querySelector("select");flsModules.select.selectBuild(r)}}}),0)},emailTest:e=>!/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,8})+$/.test(e.value)};export function formSubmit(e={validate:!0}){const t=document.forms;if(t.length)for(const e of t)e.addEventListener("submit",(function(e){r(e.target,e)})),e.addEventListener("reset",(function(e){const t=e.target;formValidate.formClean(t)}));async function r(e,t){if(0===(e.hasAttribute("data-no-validate")?0:formValidate.getErrors(e))){if(e.hasAttribute("data-ajax")){t.preventDefault();const r=e.getAttribute("action")?e.getAttribute("action").trim():"#",a=e.getAttribute("method")?e.getAttribute("method").trim():"GET",s=new FormData(e);e.classList.add("_sending");const n=await fetch(r,{method:a,body:s});if(n.ok){await n.json();e.classList.remove("_sending"),o(e)}else alert("Ошибка"),e.classList.remove("_sending")}else e.hasAttribute("data-dev")&&(t.preventDefault(),o(e))}else{t.preventDefault();const r=e.querySelector("._form-error");r&&e.hasAttribute("data-goto-error")&&gotoBlock(r,!0,1e3)}}function o(e){document.dispatchEvent(new CustomEvent("formSent",{detail:{form:e}})),setTimeout((()=>{if(flsModules.popup){const t=e.dataset.popupMessage;t&&flsModules.popup.open(t)}}),0),formValidate.formClean(e),FLS(`[Формы]: ${"Форма отправлена!"}`)}}export function formQuantity(){document.addEventListener("click",(function(e){let t=e.target;if(t.closest(".quantity__button")){let e=parseInt(t.closest(".quantity").querySelector("input").value);t.classList.contains("quantity__button_plus")?e++:(--e,e<1&&(e=1)),t.closest(".quantity").querySelector("input").value=e}}))}export function formRating(){const e=document.querySelectorAll(".rating");e.length>0&&function(){let t,r;for(let t=0;t<e.length;t++){o(e[t])}function o(e){a(e),s(),e.classList.contains("rating_set")&&n(e)}function a(e){t=e.querySelector(".rating__active"),r=e.querySelector(".rating__value")}function s(e=r.innerHTML){const o=e/.05;t.style.width=`${o}%`}function n(e){const t=e.querySelectorAll(".rating__item");for(let o=0;o<t.length;o++){const n=t[o];n.addEventListener("mouseenter",(function(t){a(e),s(n.value)})),n.addEventListener("mouseleave",(function(e){s()})),n.addEventListener("click",(function(t){a(e),e.dataset.ajax?l(n.value,e):(r.innerHTML=o+1,s())}))}}async function l(e,t){if(!t.classList.contains("rating_sending")){t.classList.add("rating_sending");let e=await fetch("rating.json",{method:"GET"});if(e.ok){const o=(await e.json()).newRating;r.innerHTML=o,s(),t.classList.remove("rating_sending")}else alert("Ошибка"),t.classList.remove("rating_sending")}}}()}